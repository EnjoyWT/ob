
### 1. 章节

-  整体概述
-  场景信息更新与保存
-  视频缓存

### 2. 整体逻辑概述

进入播放界面后，从后台请求`场景信息`, 获取到场景信息后，原生端缓存`场景信息(视频数据和节点)`到本地。视频播放器播放`默认节点`视频数据。用户输入信息后，`数智人视频组件`首先`阈值匹配`，如果有`阈值匹配`结果，则根据`匹配结果`到场景信息的`节点数据`中查找对应的`节点和视频`，`数智人视频组件`进行跳转和播放；如果没有匹配到结果，则进行`SSE请求`，根据返回进行视频播放。重复以上循环。

![[Excalidraw/Drawing 2023-09-05 11.32.35.excalidraw|Drawing 2023-09-05 11.32.35.excalidraw]]


### 场景信息更新于保存

**方案一：

- 流程：检查`服务器端`的对应`场景信息`是否更新，如果没有更新则直接使用`本地场景信息`，如果`有更新`则获取最新的`场景信息`，缓存至本地，并下载对应的`场景视频`。
-  检查更新时机： 每次进入到视频模块都会进行检查，当次采用。




**方案二：
- 视频组件打开后，检查本地是否有对应的场景信息缓存，如果没有，则请求服务器对应的`场景信息`，并缓存至本地；如果有，直接加载对应视频信息，同时检查服务端是否对应的`场景信息`是否有更新，如果有，则拉去对应的场景信息，并在下次启动`视频组件`时，加载本地缓存。
- 检查更新时机：后台静默检查，下次启动采用。

![[Excalidraw/SenceCache.excalidraw]]

### 视频缓存机制

 - 场景视频缓存机制： 场景信息更新后，会将该场景下所有的视频url 放入缓存队列。视频播放器并不会等待缓存队列结束才开始播放，而是直接播放对应节点视频。播放器在播放视频时，如果本地有对应视频会调用本地视频，如果本地没有则进行网络请求，并缓存至本地。


![[Excalidraw/VideoLocal.excalidraw]]

- 视频缓存管理： 可以对该场景下的所有视频进行统一删除管理。

![[Excalidraw/DrawingVideo.excalidraw]]